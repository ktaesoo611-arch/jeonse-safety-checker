/**
 * Korean Address Parser
 * Converts Korean addresses to Building Register API format
 */

// Seoul district codes (시군구 코드)
const SEOUL_DISTRICT_CODES: Record<string, string> = {
  '강남구': '11680',
  '강동구': '11740',
  '강북구': '11305',
  '강서구': '11500',
  '관악구': '11620',
  '광진구': '11215',
  '구로구': '11530',
  '금천구': '11545',
  '노원구': '11350',
  '도봉구': '11320',
  '동대문구': '11230',
  '동작구': '11590',
  '마포구': '11440',
  '서대문구': '11410',
  '서초구': '11650',
  '성동구': '11200',
  '성북구': '11290',
  '송파구': '11710',
  '양천구': '11470',
  '영등포구': '11560',
  '용산구': '11170',
  '은평구': '11380',
  '종로구': '11110',
  '중구': '11140',
  '중랑구': '11260'
};

// Seoul dong codes (법정동 코드) - Official codes from 행정표준코드관리시스템
// These are the last 5 digits of the 10-digit 법정동코드
const SEOUL_DONG_CODES: Record<string, Record<string, string>> = {
  '종로구': {
    '청운동': '10100',
    '신교동': '10200',
    '궁정동': '10300',
    '효자동': '10400',
    '창성동': '10500',
    '통의동': '10600',
    '적선동': '10700',
    '통인동': '10800',
    '누상동': '10900',
    '누하동': '11000',
    '옥인동': '11100',
    '체부동': '11200',
    '필운동': '11300',
    '내자동': '11400',
    '사직동': '11500',
    '도렴동': '11600',
    '당주동': '11700',
    '내수동': '11800',
    '세종로': '11900',
    '신문로1가': '12000',
    '신문로2가': '12100',
    '청진동': '12200',
    '서린동': '12300',
    '수송동': '12400',
    '중학동': '12500',
    '종로1가': '12600',
    '공평동': '12700',
    '관훈동': '12800',
    '견지동': '12900',
    '와룡동': '13000',
    '권농동': '13100',
    '운니동': '13200',
    '익선동': '13300',
    '경운동': '13400',
    '관철동': '13500',
    '인사동': '13600',
    '낙원동': '13700',
    '종로2가': '13800',
    '팔판동': '13900',
    '삼청동': '14000',
    '안국동': '14100',
    '소격동': '14200',
    '화동': '14300',
    '사간동': '14400',
    '송현동': '14500',
    '가회동': '14600',
    '재동': '14700',
    '계동': '14800',
    '원서동': '14900',
    '훈정동': '15000',
    '묘동': '15100',
    '봉익동': '15200',
    '돈의동': '15300',
    '장사동': '15400',
    '관수동': '15500',
    '종로3가': '15600',
    '인의동': '15700',
    '예지동': '15800',
    '원남동': '15900',
    '연지동': '16000',
    '종로4가': '16100',
    '효제동': '16200',
    '종로5가': '16300',
    '종로6가': '16400',
    '이화동': '16500',
    '연건동': '16600',
    '충신동': '16700',
    '동숭동': '16800',
    '혜화동': '16900',
    '명륜1가': '17000',
    '명륜2가': '17100',
    '명륜4가': '17200',
    '명륜3가': '17300',
    '창신동': '17400',
    '숭인동': '17500',
    '교남동': '17600',
    '평동': '17700',
    '송월동': '17800',
    '홍파동': '17900',
    '교북동': '18000',
    '행촌동': '18100',
    '구기동': '18200',
    '평창동': '18300',
    '부암동': '18400',
    '홍지동': '18500',
    '신영동': '18600',
    '무악동': '18700'
  },
  '중구': {
    '무교동': '10100',
    '다동': '10200',
    '태평로1가': '10300',
    '을지로1가': '10400',
    '을지로2가': '10500',
    '남대문로1가': '10600',
    '삼각동': '10700',
    '수하동': '10800',
    '장교동': '10900',
    '수표동': '11000',
    '소공동': '11100',
    '남창동': '11200',
    '북창동': '11300',
    '태평로2가': '11400',
    '남대문로2가': '11500',
    '남대문로3가': '11600',
    '남대문로4가': '11700',
    '남대문로5가': '11800',
    '봉래동1가': '11900',
    '봉래동2가': '12000',
    '회현동1가': '12100',
    '회현동2가': '12200',
    '회현동3가': '12300',
    '충무로1가': '12400',
    '충무로2가': '12500',
    '명동1가': '12600',
    '명동2가': '12700',
    '남산동1가': '12800',
    '남산동2가': '12900',
    '남산동3가': '13000',
    '저동1가': '13100',
    '충무로4가': '13200',
    '충무로5가': '13300',
    '인현동2가': '13400',
    '예관동': '13500',
    '묵정동': '13600',
    '필동1가': '13700',
    '필동2가': '13800',
    '필동3가': '13900',
    '남학동': '14000',
    '주자동': '14100',
    '예장동': '14200',
    '장충동1가': '14300',
    '장충동2가': '14400',
    '광희동1가': '14500',
    '광희동2가': '14600',
    '쌍림동': '14700',
    '을지로6가': '14800',
    '을지로7가': '14900',
    '을지로4가': '15000',
    '을지로5가': '15100',
    '주교동': '15200',
    '방산동': '15300',
    '오장동': '15400',
    '을지로3가': '15500',
    '입정동': '15600',
    '산림동': '15700',
    '충무로3가': '15800',
    '초동': '15900',
    '인현동1가': '16000',
    '저동2가': '16100',
    '신당동': '16200',
    '흥인동': '16300',
    '무학동': '16400',
    '황학동': '16500',
    '서소문동': '16600',
    '정동': '16700',
    '순화동': '16800',
    '의주로1가': '16900',
    '충정로1가': '17000',
    '중림동': '17100',
    '의주로2가': '17200',
    '만리동1가': '17300',
    '만리동2가': '17400'
  },
  '용산구': {
    '후암동': '10100',
    '용산동2가': '10200',
    '용산동4가': '10300',
    '갈월동': '10400',
    '남영동': '10500',
    '용산동1가': '10600',
    '동자동': '10700',
    '서계동': '10800',
    '청파동1가': '10900',
    '청파동2가': '11000',
    '청파동3가': '11100',
    '원효로1가': '11200',
    '원효로2가': '11300',
    '신창동': '11400',
    '산천동': '11500',
    '청암동': '11600',
    '원효로3가': '11700',
    '원효로4가': '11800',
    '효창동': '11900',
    '도원동': '12000',
    '용문동': '12100',
    '문배동': '12200',
    '신계동': '12300',
    '한강로1가': '12400',
    '한강로2가': '12500',
    '용산동3가': '12600',
    '용산동5가': '12700',
    '한강로3가': '12800',
    '이촌동': '12900',
    '이태원동': '13000',
    '한남동': '13100',
    '동빙고동': '13200',
    '서빙고동': '13300',
    '주성동': '13400',
    '용산동6가': '13500',
    '보광동': '13600'
  },
  '성동구': {
    '상왕십리동': '10100',
    '하왕십리동': '10200',
    '홍익동': '10300',
    '도선동': '10400',
    '마장동': '10500',
    '사근동': '10600',
    '행당동': '10700',
    '응봉동': '10800',
    '금호동1가': '10900',
    '금호동2가': '11000',
    '금호동3가': '11100',
    '금호동4가': '11200',
    '옥수동': '11300',
    '성수동1가': '11400',
    '성수동2가': '11500',
    '송정동': '11800',
    '용답동': '12200'
  },
  '광진구': {
    '중곡동': '10100',
    '능동': '10200',
    '구의동': '10300',
    '광장동': '10400',
    '자양동': '10500',
    '화양동': '10700',
    '군자동': '10900'
  },
  '동대문구': {
    '신설동': '10100',
    '용두동': '10200',
    '제기동': '10300',
    '전농동': '10400',
    '답십리동': '10500',
    '장안동': '10600',
    '청량리동': '10700',
    '회기동': '10800',
    '휘경동': '10900',
    '이문동': '11000'
  },
  '중랑구': {
    '면목동': '10100',
    '상봉동': '10200',
    '중화동': '10300',
    '묵동': '10400',
    '망우동': '10500',
    '신내동': '10600'
  },
  '성북구': {
    '성북동': '10100',
    '성북동1가': '10200',
    '돈암동': '10300',
    '동소문동1가': '10400',
    '동소문동2가': '10500',
    '동소문동3가': '10600',
    '동소문동4가': '10700',
    '동소문동5가': '10800',
    '동소문동6가': '10900',
    '동소문동7가': '11000',
    '삼선동1가': '11100',
    '삼선동2가': '11200',
    '삼선동3가': '11300',
    '삼선동4가': '11400',
    '삼선동5가': '11500',
    '동선동1가': '11600',
    '동선동2가': '11700',
    '동선동3가': '11800',
    '동선동4가': '11900',
    '동선동5가': '12000',
    '안암동1가': '12100',
    '안암동2가': '12200',
    '안암동3가': '12300',
    '안암동4가': '12400',
    '안암동5가': '12500',
    '보문동4가': '12600',
    '보문동5가': '12700',
    '보문동6가': '12800',
    '보문동7가': '12900',
    '보문동1가': '13000',
    '보문동2가': '13100',
    '보문동3가': '13200',
    '정릉동': '13300',
    '길음동': '13400',
    '종암동': '13500',
    '하월곡동': '13600',
    '상월곡동': '13700',
    '장위동': '13800',
    '석관동': '13900'
  },
  '강북구': {
    '미아동': '10100',
    '번동': '10200',
    '수유동': '10300',
    '우이동': '10400'
  },
  '도봉구': {
    '쌍문동': '10500',
    '방학동': '10600',
    '창동': '10700',
    '도봉동': '10800'
  },
  '노원구': {
    '월계동': '10200',
    '공릉동': '10300',
    '하계동': '10400',
    '상계동': '10500',
    '중계동': '10600'
  },
  '은평구': {
    '수색동': '10100',
    '녹번동': '10200',
    '불광동': '10300',
    '갈현동': '10400',
    '구산동': '10500',
    '대조동': '10600',
    '응암동': '10700',
    '역촌동': '10800',
    '신사동': '10900',
    '증산동': '11000',
    '진관동': '11400'
  },
  '서대문구': {
    '충정로2가': '10100',
    '충정로3가': '10200',
    '합동': '10300',
    '미근동': '10400',
    '냉천동': '10500',
    '천연동': '10600',
    '옥천동': '10700',
    '영천동': '10800',
    '현저동': '10900',
    '북아현동': '11000',
    '홍제동': '11100',
    '대현동': '11200',
    '대신동': '11300',
    '신촌동': '11400',
    '봉원동': '11500',
    '창천동': '11600',
    '연희동': '11700',
    '홍은동': '11800',
    '북가좌동': '11900',
    '남가좌동': '12000'
  },
  '마포구': {
    '아현동': '10100',
    '공덕동': '10200',
    '신공덕동': '10300',
    '도화동': '10400',
    '용강동': '10500',
    '토정동': '10600',
    '마포동': '10700',
    '대흥동': '10800',
    '염리동': '10900',
    '노고산동': '11000',
    '신수동': '11100',
    '현석동': '11200',
    '구수동': '11300',
    '창전동': '11400',
    '상수동': '11500',
    '하중동': '11600',
    '신정동': '11700',
    '당인동': '11800',
    '서교동': '12000',
    '동교동': '12100',
    '합정동': '12200',
    '망원동': '12300',
    '연남동': '12400',
    '성산동': '12500',
    '중동': '12600',
    '상암동': '12700'
  },
  '양천구': {
    '신정동': '10100',
    '목동': '10200',
    '신월동': '10300'
  },
  '강서구': {
    '염창동': '10100',
    '등촌동': '10200',
    '화곡동': '10300',
    '가양동': '10400',
    '마곡동': '10500',
    '내발산동': '10600',
    '외발산동': '10700',
    '공항동': '10800',
    '방화동': '10900',
    '개화동': '11000',
    '과해동': '11100',
    '오곡동': '11200',
    '오쇠동': '11300'
  },
  '구로구': {
    '신도림동': '10100',
    '구로동': '10200',
    '가리봉동': '10300',
    '고척동': '10600',
    '개봉동': '10700',
    '오류동': '10800',
    '궁동': '10900',
    '온수동': '11000',
    '천왕동': '11100',
    '항동': '11200'
  },
  '금천구': {
    '가산동': '10100',
    '독산동': '10200',
    '시흥동': '10300'
  },
  '영등포구': {
    '영등포동': '10100',
    '영등포동1가': '10200',
    '영등포동2가': '10300',
    '영등포동3가': '10400',
    '영등포동4가': '10500',
    '영등포동5가': '10600',
    '영등포동6가': '10700',
    '영등포동7가': '10800',
    '영등포동8가': '10900',
    '여의도동': '11000',
    '당산동1가': '11100',
    '당산동2가': '11200',
    '당산동3가': '11300',
    '당산동4가': '11400',
    '당산동5가': '11500',
    '당산동6가': '11600',
    '당산동': '11700',
    '도림동': '11800',
    '문래동1가': '11900',
    '문래동2가': '12000',
    '문래동3가': '12100',
    '문래동4가': '12200',
    '문래동5가': '12300',
    '문래동6가': '12400',
    '양평동1가': '12500',
    '양평동2가': '12600',
    '양평동3가': '12700',
    '양평동4가': '12800',
    '양평동5가': '12900',
    '양평동6가': '13000',
    '양화동': '13100',
    '신길동': '13200',
    '대림동': '13300',
    '양평동': '13400'
  },
  '동작구': {
    '노량진동': '10100',
    '상도동': '10200',
    '상도1동': '10300',
    '본동': '10400',
    '흑석동': '10500',
    '동작동': '10600',
    '사당동': '10700',
    '대방동': '10800',
    '신대방동': '10900'
  },
  '관악구': {
    '봉천동': '10100',
    '신림동': '10200',
    '남현동': '10300'
  },
  '서초구': {
    '방배동': '10100',
    '양재동': '10200',
    '우면동': '10300',
    '원지동': '10400',
    '잠원동': '10600',
    '반포동': '10700',
    '서초동': '10800',
    '내곡동': '10900',
    '염곡동': '11000',
    '신원동': '11100'
  },
  '강남구': {
    '역삼동': '10100',
    '개포동': '10300',
    '청담동': '10400',
    '삼성동': '10500',
    '대치동': '10600',
    '신사동': '10700',
    '논현동': '10800',
    '압구정동': '11000',
    '세곡동': '11100',
    '자곡동': '11200',
    '율현동': '11300',
    '일원동': '11400',
    '수서동': '11500',
    '도곡동': '11800'
  },
  '송파구': {
    '잠실동': '10100',
    '신천동': '10200',
    '풍납동': '10300',
    '송파동': '10400',
    '석촌동': '10500',
    '삼전동': '10600',
    '가락동': '10700',
    '문정동': '10800',
    '장지동': '10900',
    '방이동': '11100',
    '오금동': '11200',
    '거여동': '11300',
    '마천동': '11400'
  },
  '강동구': {
    '명일동': '10100',
    '고덕동': '10200',
    '상일동': '10300',
    '길동': '10500',
    '둔촌동': '10600',
    '암사동': '10700',
    '성내동': '10800',
    '천호동': '10900',
    '강일동': '11000'
  }
};

export interface AddressComponents {
  sigunguCd: string;  // 시군구 코드
  bjdongCd: string;   // 법정동 코드
  platGbCd: string;   // 대지구분코드: 0=대지, 1=산, 2=블록
  bun: string;        // 본번 (main lot number) - 4 digits
  ji: string;         // 부번 (sub lot number) - 4 digits
}

/**
 * Parse Korean address into Building Register API components
 */
export function parseKoreanAddress(address: string): AddressComponents | null {
  // Clean up address
  const cleanAddress = address.trim();

  // Extract district (구)
  const districtMatch = cleanAddress.match(/([가-힣]+구)/);
  if (!districtMatch) {
    console.warn('Could not extract district from address:', address);
    return null;
  }
  const district = districtMatch[1];

  // Get district code
  const sigunguCd = SEOUL_DISTRICT_CODES[district];
  if (!sigunguCd) {
    console.warn('Unknown district:', district);
    return null;
  }

  // Extract dong (동)
  const dongMatch = cleanAddress.match(/([가-힣]+동\d*가?|[가-힣]+가)/);
  if (!dongMatch) {
    console.warn('Could not extract dong from address:', address);
    return null;
  }
  const dong = dongMatch[1];

  // Get dong code
  const bjdongCd = SEOUL_DONG_CODES[district]?.[dong];
  if (!bjdongCd) {
    console.warn(`Unknown dong: ${dong} in ${district}`);
    // Return null instead of mock data - API won't work with wrong codes
    return null;
  }

  // Extract lot number (번지)
  // Patterns: "435", "123-45", "123번지", etc.
  const lotMatch = cleanAddress.match(/(\d+)(?:-(\d+))?(?:번지)?/);
  if (!lotMatch) {
    console.warn('Could not extract lot number from address:', address);
    return null;
  }

  const bun = lotMatch[1].padStart(4, '0'); // Main lot number (4 digits)
  const ji = (lotMatch[2] || '0').padStart(4, '0'); // Sub lot number (4 digits, default to 0000)

  // Determine platGbCd (대지구분코드)
  // 0 = 대지 (land), 1 = 산 (mountain), 2 = 블록 (block)
  // Check for "산" as a lot type (e.g., "산 123"), not as part of district name
  const platGbCd = /\s산\s|\s산\d/.test(cleanAddress) ? '1' : '0';

  return {
    sigunguCd,
    bjdongCd,
    platGbCd,
    bun,
    ji
  };
}

/**
 * Format address components for display
 */
export function formatAddressComponents(components: AddressComponents): string {
  return `sigunguCd: ${components.sigunguCd}, bjdongCd: ${components.bjdongCd}, platGbCd: ${components.platGbCd}, bun: ${components.bun}, ji: ${components.ji}`;
}
